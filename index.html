<!--
File: /FLOW/Audio/Looper/good_looper6.html
What it does: Looper UI with metronome/transport, per-track LEDs, time signature controls, recording, and playback.
Change log (2025-10-06): Increased LED strip from 16 → 32 cells and expanded time-signature top selector to 1..32.
Credit: Created by Scott Russo.
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flow Looper</title>
<style>
:root{
  --bg:#0d0f14;--panel:#141824;--ink:#e9eef7;--ink-dim:#9ba7bd;
  --accent:#5aa7ff;--accent-2:#8b5cf6;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --grid:#1d2333;--grid-2:#232a3d;--chip:#0f1320;--muted:#3b435a;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
.app{max-width:1200px;margin:0 auto;padding:16px}
.h{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.h .title{font-weight:700;font-size:20px;letter-spacing:.3px}
.h .sp{flex:1}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--panel);border:1px solid #1f2538;border-radius:14px;padding:12px}
.card h3{margin:0 0 10px 0;font-size:14px;color:var(--ink-dim);letter-spacing:.2px;text-transform:uppercase}
.small{font-size:12px;color:var(--ink-dim)}
.btn{padding:8px 10px;border-radius:10px;border:1px solid var(--muted);background:#0f1220;color:var(--ink);cursor:pointer;min-width:44px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.primary{border-color:var(--accent);background:linear-gradient(180deg,#16213b,#101529)}
.btn.ok{border-color:var(--ok)}
.btn.warn{border-color:var(--warn)}
.btn.bad{border-color:var(--bad)}
.btn.ghost{background:transparent}
.group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.label{font-size:12px;color:var(--ink-dim)}
.input{padding:6px 8px;border-radius:8px;border:1px solid var(--muted);background:#0f1320;color:var(--ink)}
select.input{padding:6px 24px 6px 8px}
.num{width:64px;text-align:center}

/* Transport */
.transport{display:flex;gap:8px;align-items:center}
.led{width:10px;height:10px;border-radius:3px;background:#1b2031;border:1px solid #2a3046}
.led.on{background:var(--accent)}
.cursor{height:12px;width:2px;background:var(--accent-2);border-radius:1px}

/* Timeline LEDs (changed 16 -> 32 columns) */
.leds{display:grid;grid-template-columns:repeat(32,1fr);gap:3px}
.leds .cell{height:14px;border-radius:4px;background:#151a29;border:1px solid #20263b}
.leds .cell.on{background:linear-gradient(180deg,#538cff,#2a57d8);border-color:#3a56a0;box-shadow:0 0 6px rgba(90,167,255,0.7)}
.leds .cell.bar{background:#172038}
.leds .cell.beat{outline:1px dashed #2f3a5b}

/* Tracks */
.tracks{display:flex;flex-direction:column;gap:10px}
.track{display:grid;grid-template-columns:140px 1fr 220px;gap:10px;align-items:center}
.track .name{font-weight:600}
.track .mixer{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.track .mixer .btn{min-width:36px}

/* Footer */
footer{margin-top:16px;display:flex;gap:12px;align-items:center;justify-content:space-between}

/* Panels */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.stack{display:flex;flex-direction:column;gap:10px}

/* FX stub modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(3px)}
.modal.open{display:flex}
.modal .win{width:min(720px,95vw);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid #26304b;border-radius:16px;padding:16px}
.modal .win h3{margin:0 0 10px 0}
.modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

/* Meter */
.meter{height:8px;width:100px;border-radius:6px;background:#111525;border:1px solid #27304a;position:relative;overflow:hidden}
.meter .fill{position:absolute;inset:0;width:20%;background:linear-gradient(90deg,#2f8cff,#7a5cff)}
</style>
</head>
<body>
<div class="app">
  <div class="h">
    <div class="title">Flow Looper</div>
    <div class="sp"></div>
    <div class="group small">
      <span class="label">Audio</span>
      <button id="enableAudio" class="btn ok">Enable Audio + Mic</button>
    </div>
  </div>

  <div class="row">
    <div class="card" style="flex:1;min-width:320px">
      <h3>Transport</h3>
      <div class="transport">
        <button id="play" class="btn primary">Play</button>
        <button id="stop" class="btn">Stop</button>
        <button id="rec" class="btn bad">Rec</button>
        <div class="sp"></div>
        <span class="label">BPM</span>
        <input id="bpm" class="input num" type="number" min="20" max="300" value="110" />
        <span class="label">Bars</span>
        <input id="bars" class="input num" type="number" min="1" max="64" value="8" />
        <span class="label">Swing</span>
        <input id="swing" class="input num" type="number" min="0" max="80" step="1" value="0" />
      </div>

      <div class="group" style="margin-top:10px">
        <span class="label">Time Signature</span>
        <select id="timeTop" class="input"></select>
        <span>/</span>
        <select id="timeBottom" class="input">
          <option value="2">2</option>
          <option value="4" selected>4</option>
          <option value="8">8</option>
          <option value="16">16</option>
        </select>
        <div class="sp"></div>
        <span class="label">Metronome</span>
        <div class="led" id="metroLed"></div>
      </div>
    </div>

    <div class="card" style="width:360px;min-width:300px">
      <h3>Master</h3>
      <div class="stack">
        <div class="group">
          <span class="label">Volume</span>
          <input id="masterVol" class="input" type="range" min="0" max="1" step="0.01" value="0.9" />
        </div>
        <div class="group">
          <span class="label">Monitor</span>
          <div class="meter"><div id="masterMeter" class="fill"></div></div>
        </div>
        <div class="group">
          <button id="openFX" class="btn">FX</button>
          <button id="openMixer" class="btn">Mixer</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Tracks</h3>
    <div id="tracks" class="tracks"></div>
  </div>

  <footer>
    <div class="small">Tips: Use Play → Rec to overdub. Time signature supports odd meters. LEDs show current subdivision and bar boundaries.</div>
    <div class="group">
      <button id="save" class="btn">Save</button>
      <button id="load" class="btn">Load</button>
      <button id="clear" class="btn warn">Clear</button>
    </div>
  </footer>
</div>

<!-- FX Modal -->
<div id="fxModal" class="modal" aria-hidden="true">
  <div class="win">
    <h3>Per-Track FX (stub)</h3>
    <div class="fx-grid">
      <div class="group"><span class="label">EQ</span><input type="range" min="-12" max="12" step="0.1" value="0" class="input" /></div>
      <div class="group"><span class="label">Delay</span><input type="range" min="0" max="1" step="0.01" value="0.25" class="input" /></div>
      <div class="group"><span class="label">Reverb</span><input type="range" min="0" max="1" step="0.01" value="0.2" class="input" /></div>
      <div class="group"><span class="label">Chorus</span><input type="range" min="0" max="1" step="0.01" value="0.15" class="input" /></div>
      <div class="group"><span class="label">Phaser</span><input type="range" min="0" max="1" step="0.01" value="0.1" class="input" /></div>
      <div class="group"><span class="label">Compressor</span><input type="range" min="1" max="20" step="0.1" value="4" class="input" /></div>
    </div>
    <div class="actions">
      <button id="closeFX" class="btn ok">Done</button>
    </div>
  </div>
</div>

<script>
// ============================
// Transport / Engine Settings
// ============================
let audioStarted = false;
let isPlaying = false;
let isRecording = false;

// Core grid sizing
const N = 8, LED_CELLS = 32; // (changed from 16 to 32)

// State
const state = {
  bpm: 110,
  bars: 8,
  swing: 0,
  timeTop: 4,
  timeBottom: 4,
  masterVol: 0.9,
  pos: 0,          // substep position within the loop
  loopLen: 0,      // computed total substeps
  tracks: []
};

// Elements
const timeTopSel = document.getElementById('timeTop'),
      timeBottomSel = document.getElementById('timeBottom'),
      bpmEl = document.getElementById('bpm'),
      barsEl = document.getElementById('bars'),
      swingEl = document.getElementById('swing'),
      playBtn = document.getElementById('play'),
      stopBtn = document.getElementById('stop'),
      recBtn = document.getElementById('rec'),
      enableAudioBtn = document.getElementById('enableAudio'),
      masterVolEl = document.getElementById('masterVol'),
      masterMeterFill = document.getElementById('masterMeter'),
      openFXBtn = document.getElementById('openFX'),
      openMixerBtn = document.getElementById('openMixer'),
      fxModal = document.getElementById('fxModal'),
      closeFXBtn = document.getElementById('closeFX'),
      tracksEl = document.getElementById('tracks'),
      metroLed = document.getElementById('metroLed');

// Populate time signature top 1..32 (changed upper bound)
(function populateTimeTop(){
  for (let i=1;i<=32;i++){
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = String(i);
    if (i===4) opt.selected = true;
    timeTopSel.appendChild(opt);
  }
})();

// Populate tracks (4 demo tracks)
const TRACK_COUNT = 4;
function makeEmptyPattern() {
  // pattern is 2D: bars x LED_CELLS; boolean flags for "has data at step"
  const bars = Number(barsEl.value|0) || 8;
  const patt = [];
  for (let b=0;b<bars;b++){
    const row = new Array(LED_CELLS).fill(false);
    patt.push(row);
  }
  return patt;
}

function addTrack(i){
  const t = {
    id:i, name:`Track ${i+1}`, armed:false, mute:false, solo:false, gain:1.0,
    pattern: makeEmptyPattern()
  };
  state.tracks.push(t);
  renderTrack(t);
}

function renderTrack(t){
  const el = document.createElement('div');
  el.className = 'track';
  el.dataset.id = t.id;

  // Name / arm
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = t.name;
  el.appendChild(name);

  // LEDs
  const leds = document.createElement('div');
  leds.className = 'leds';
  // Fill with bars x LED_CELLS cells
  for (let b=0;b<state.bars;b++){
    for (let i=0;i<LED_CELLS;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      // visually mark beat/bar
      if (i % (LED_CELLS / state.timeTop || 4) === 0) cell.classList.add('beat');
      if (i===0) cell.classList.add('bar');
      cell.addEventListener('click', ()=>{
        t.pattern[b][i] = !t.pattern[b][i];
        cell.classList.toggle('on', t.pattern[b][i]);
      });
      leds.appendChild(cell);
    }
  }
  el.appendChild(leds);

  // Mixer strip
  const mix = document.createElement('div');
  mix.className = 'mixer';
  const arm = mkBtn('Arm', 'bad', ()=>{t.armed=!t.armed; arm.classList.toggle('bad', t.armed);});
  const mute = mkBtn('Mute', '', ()=>{t.mute=!t.mute; mute.classList.toggle('warn', t.mute);});
  const solo = mkBtn('Solo', '', ()=>{t.solo=!t.solo; solo.classList.toggle('ok', t.solo);});
  const fx = mkBtn('FX', '', ()=> fxModal.classList.add('open'));
  mix.appendChild(arm); mix.appendChild(mute); mix.appendChild(solo); mix.appendChild(fx);
  el.appendChild(mix);

  tracksEl.appendChild(el);
}

function mkBtn(text, cls, fn){
  const b = document.createElement('button');
  b.className = 'btn' + (cls?(' '+cls):'');
  b.textContent = text;
  b.addEventListener('click', fn);
  return b;
}

// Build initial tracks
for (let i=0;i<TRACK_COUNT;i++) addTrack(i);

// -------------
// Audio Engine (stubbed for UI — hook your WebAudio graph here)
// -------------
let ctx = null, masterGain = null;

enableAudioBtn.addEventListener('click', async ()=>{
  if (audioStarted) return;
  try{
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = ctx.createGain();
    masterGain.gain.value = state.masterVol;
    masterGain.connect(ctx.destination);
    // Request mic for monitoring/recording
    await navigator.mediaDevices.getUserMedia({audio:true});
    audioStarted = true;
    enableAudioBtn.textContent = 'Audio Ready';
    enableAudioBtn.disabled = true;
  }catch(err){
    alert('Mic/Audio permission failed: '+err.message);
  }
});

masterVolEl.addEventListener('input', (e)=>{
  state.masterVol = Number(e.target.value);
  if (masterGain) masterGain.gain.value = state.masterVol;
});

// -------------
// Transport / Clock
// -------------
function recalcLoopLen(){
  // total substeps per bar = LED_CELLS
  // total = bars * LED_CELLS
  state.bars = Number(barsEl.value|0) || 8;
  const top = Number(timeTopSel.value|0) || 4;
  const bot = Number(timeBottomSel.value|0) || 4;
  state.timeTop = top;
  state.timeBottom = bot;
  state.loopLen = state.bars * LED_CELLS;
  // re-render beat/measure guides on LEDs
  document.querySelectorAll('.track').forEach((trackEl, idx)=>{
    const leds = trackEl.querySelector('.leds');
    if (!leds) return;
    const cells = leds.querySelectorAll('.cell');
    let k=0;
    for (let b=0;b<state.bars;b++){
      for (let i=0;i<LED_CELLS;i++){
        const c = cells[k++];
        c.classList.toggle('beat', (i % (LED_CELLS / state.timeTop || 4) === 0));
        c.classList.toggle('bar', i===0);
      }
    }
  });
}

[bpmEl,barsEl,swingEl,timeTopSel,timeBottomSel].forEach(el=>{
  el.addEventListener('input', ()=>{
    state.bpm = Number(bpmEl.value|0)||110;
    recalcLoopLen();
  });
});

function stepIntervalMs(){
  // Base: 1 beat = quarter note = 60k/BPM ms
  // We map LED_CELLS per bar; with timeTop beats per bar => substeps per beat = LED_CELLS / timeTop
  const beatsPerMin = state.bpm;
  const msPerBeat = 60000 / beatsPerMin;
  const substepsPerBeat = LED_CELLS / (state.timeTop || 4);
  const base = msPerBeat / substepsPerBeat;
  if (!state.swing) return base;
  // Simple swing: delay every other substep by factor
  const swingAmt = Math.min(Math.max(state.swing,0),80) / 100;
  return base * (1 + swingAmt * ((state.pos % 2) ? 1 : -0.5));
}

let rafId = 0, lastTick = 0, accMs = 0;
function tick(ts){
  if (!isPlaying){rafId=0;return;}
  if (!lastTick) lastTick = ts;
  const dt = ts - lastTick; lastTick = ts;
  accMs += dt;
  const target = stepIntervalMs();
  if (accMs >= target){
    accMs -= target;
    advance();
  }
  rafId = requestAnimationFrame(tick);
}

function advance(){
  // Move transport
  state.pos = (state.pos + 1) % (state.loopLen || LED_CELLS);
  // flash metro roughly on beats
  const isBeat = (state.pos % (LED_CELLS / (state.timeTop || 4))) === 0;
  metroLed.classList.toggle('on', isBeat);
  // light track cells
  const perTrack = document.querySelectorAll('.track');
  let k=0;
  for (let ti=0;ti<state.tracks.length;ti++){
    const t = state.tracks[ti];
    const el = perTrack[ti];
    const cells = el.querySelectorAll('.cell');
    const barIndex = Math.floor(state.pos / LED_CELLS);
    const stepIndex = state.pos % LED_CELLS;
    // update a cursor highlight by toggling one cell
    // (optional enhancement: keep a separate "cursor" element)
    for (let b=0;b<state.bars;b++){
      for (let i=0;i<LED_CELLS;i++){
        const idx = b*LED_CELLS + i;
        const c = cells[idx];
        const on = t.pattern[b][i];
        c.classList.toggle('on', on);
        // No heavy per-step DOM renders beyond 'on' (keep light)
      }
    }
    // TODO: actual audio playback would fire here based on t.pattern[barIndex][stepIndex]
  }
  // fake meter activity
  masterMeterFill.style.width = (10 + (state.pos % 80)) + '%';
}

// Controls
playBtn.addEventListener('click', ()=>{
  if (isPlaying) return;
  isPlaying = true;
  lastTick = 0; accMs = 0;
  recalcLoopLen();
  rafId = requestAnimationFrame(tick);
});

stopBtn.addEventListener('click', ()=>{
  isPlaying = false;
  if (rafId) cancelAnimationFrame(rafId);
  rafId = 0; lastTick=0; accMs=0;
  state.pos = 0;
  metroLed.classList.remove('on');
});

recBtn.addEventListener('click', ()=>{
  isRecording = !isRecording;
  recBtn.classList.toggle('bad', isRecording);
});

// FX Modal
openFXBtn.addEventListener('click', ()=> fxModal.classList.add('open'));
closeFXBtn.addEventListener('click', ()=> fxModal.classList.remove('open'));
fxModal.addEventListener('click', (e)=>{ if (e.target===fxModal) fxModal.classList.remove('open'); });

// Save/Load/Clear
document.getElementById('save').addEventListener('click', ()=>{
  const payload = JSON.stringify({state}, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([payload],{type:'application/json'}));
  a.download = 'flow_looper_session.json';
  a.click();
});
document.getElementById('load').addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = async ()=>{
    const file = inp.files?.[0]; if (!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if (data && data.state){
        Object.assign(state, data.state);
        // Rebuild UI from loaded state
        bpmEl.value = state.bpm;
        barsEl.value = state.bars;
        masterVolEl.value = state.masterVol;
        timeTopSel.value = state.timeTop;
        timeBottomSel.value = state.timeBottom;
        tracksEl.innerHTML = '';
        state.tracks = [];
        for (let i=0;i<(data.state.tracks?.length||4);i++){
          addTrack(i);
          if (data.state.tracks[i]){
            state.tracks[i].name = data.state.tracks[i].name || state.tracks[i].name;
            state.tracks[i].pattern = data.state.tracks[i].pattern || state.tracks[i].pattern;
          }
        }
        recalcLoopLen();
      }
    }catch(e){
      alert('Invalid session file.');
    }
  };
  inp.click();
});
document.getElementById('clear').addEventListener('click', ()=>{
  state.tracks = [];
  tracksEl.innerHTML = '';
  for (let i=0;i<TRACK_COUNT;i++) addTrack(i);
  recalcLoopLen();
});

// Initialize loop size once
recalcLoopLen();
</script>
</body>
</html>
